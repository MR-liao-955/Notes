### 根据 WMBUS 表配置出现的现象

> 前言：测试 WMBUS 网关，向模块网关中放入相应测试文件，出现的现象。

[toc]



#### 表配置( Meter Configuration )

##### 表配置状态码 '01'

- 文件夹 `CONFIGURATION_OUT_FOLDER` 下存放文件用以生成目标文件。

  文件名：`TEST00004_CONF_SETUP_VER_2011231134.csv`

  存放内容：

  ```bash
  DCWA00001,10.0.0.233,123,21-11-2023 11:34
  20713173,WHFWL200065004,ITL,01
  74897904,WHFWL200005721,KAL,01
  81442547,WHFWL180038545,AEL,01
  ```

  现象：隔一段时间后自动生成文件

  1. 文件夹: `CONFIGURATION_OUT_FOLDER`

     生成ACK 文件 `TEST00001_CONF_VER_2011231834_ACK.csv`

     生成内容:

     ```bash
     TEST00001,10.10.10.233
     20-11-2023 18:34,20713171,WHFWL20006504,ITL,01,01
     ```

  2. 文件夹: `ON_DEMAND_READ_REQ_IN_ACK`

     生成ACK 文件 `_ONDEMAND_2111231112_REQ_ACK.csv`

     生成内容: 

     ```bash
     ,,ESY,21-11-2023 11:12,00
     ,,ESY,21-11-2023 11:12,00
     ,,ESY,21-11-2023 11:12,00
     ,,ESY,21-11-2023 11:12,00
     ```

  3. 文件夹: `METER_READ_OUT_FOLDER`  

     注：( 该文件并不一定是原模原样TEST00004_CONF_SETUP_VER_2011231134.csv生成的, 但是绝对是这类文件生成 )

     生成ACK 文件 `TEST00001_DCU_EVENT_2011231814.csv`

     生成内容: 

     ```bash
     TEST00001,10.10.10.233,ESY
     20-11-2023 18:35,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     20-11-2023 18:50,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     20-11-2023 19:10,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     20-11-2023 19:30,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     20-11-2023 19:45,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     20-11-2023 20:00,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     20-11-2023 20:20,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     20-11-2023 20:45,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     20-11-2023 21:00,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     20-11-2023 21:20,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     20-11-2023 21:35,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     20-11-2023 21:50,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     20-11-2023 22:05,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     20-11-2023 22:20,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     20-11-2023 22:35,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     20-11-2023 22:50,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     20-11-2023 23:05,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     20-11-2023 23:20,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     20-11-2023 23:35,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     20-11-2023 23:50,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 00:20,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 00:35,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 00:50,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 01:05,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 01:20,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 01:40,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 01:55,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 02:10,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 02:25,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 02:40,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 02:56,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 03:15,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 03:35,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 04:00,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 04:15,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 04:30,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 04:50,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 05:10,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 05:30,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 05:50,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 06:05,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 06:20,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 06:45,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 07:05,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 07:25,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 07:40,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 08:00,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 08:25,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 08:45,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 09:05,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 09:20,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 09:40,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 10:00,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 10:20,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 10:40,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 10:55,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 11:15,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 11:40,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 11:40,74897902,WHFWL200005721,KAL,0.000000,0.000000,0.000000,,03
     21-11-2023 11:40,81442545,WHFWL180038545,AEL,0.000000,0.000000,0.000000,,03
     21-11-2023 11:55,20713171,WHFWL20006504,ITL,0.000000,0.000000,0.000000,,03
     21-11-2023 11:55,74897902,WHFWL200005721,KAL,0.000000,0.000000,0.000000,,03
     21-11-2023 11:55,81442545,WHFWL180038545,AEL,0.000000,0.000000,0.000000,,03
     ```

##### 表配置状态码 '05'

- 文件夹 `` 下存放文件用以生成目标文件。

  文件名：``

  存放内容：

  ```bash
  
  ```

  现象：隔一段时间后自动生成文件

  1. 文件夹: ``

     生成ACK 文件 ``

     生成内容:

     ```bash
     
     ```

  2. 文件夹: ``

     生成ACK 文件 ``

     生成内容: 



##### 表配置状态码 '02'

- 文件夹 `` 下存放文件用以生成目标文件。

  文件名：``

  存放内容：

  ```bash
  
  ```

  现象：隔一段时间后自动生成文件

  1. 文件夹: ``

     生成ACK 文件 ``

     生成内容:

     ```bash
     
     ```

  2. 文件夹: ``

     生成ACK 文件 ``

     生成内容: 



##### 表配置状态码 '03 & 04'

- 文件夹 `` 下存放文件用以生成目标文件。

  文件名：``

  存放内容：

  ```bash
  
  ```

  现象：隔一段时间后自动生成文件

  1. 文件夹: ``

     生成ACK 文件 ``

     生成内容:

     ```bash
     
     ```

  2. 文件夹: ``

     生成ACK 文件 ``

     生成内容: 





#### On-Demand Meter data 按需取表数据

文件夹 `ON_DEMAND_READ_REQ_IN` 下存放文件用以生成目标文件。

文件名：`DCWA19088_ONEDEMAND_2111231410_REQ.csv` ，( 如果该文件不存在，那么 ACK 文件就不会生成，而且，如果存在该文件，那么ACK 文件就一直生成 )

存放内容：

```bash
DCWA19088,10.0.0.233,21-11-2023 14:11
20713171,WHFWL200065004,ITL
74897902,WHFWL200005721,KAL
81442545,WHFWL180038545,AEL
81440874,WHFWL180036874,AEL
81440873,WHFWL180036873,AEL
```

现象：隔大概 18 分钟重启后自动生成文件 ( 设备看门狗定时器设置的 18 分钟 ? )

1. 文件夹: `ON_DEMAND_READ_REQ_IN_ACK`

   生成ACK 文件 `DCWA19088_ONDEMAND_2111231432_REQ_ACK.csv`

   生成内容:

   ```bash
   DCWA19088,10.0.0.233,ESY,21-11-2023 14:32,00
   DCWA19088,10.0.0.233,ESY,21-11-2023 14:32,00
   ```

2. 文件夹: `ON_DEMAND_READ_OUT` 生成数据表文件

   生成 ACK 文件 `DCWA19088_ONDEMAND_2111231429_ACK.csv`

   生成内容:

   ```bash
   DCWA19088,10.0.0.233
   21-11-2023 14:29,20713171,WHFWL200065004,ITL,0.000000,0.000000,0.000000,,02
   21-11-2023 14:29,74897902,WHFWL200005721,KAL,0.000000,0.000000,0.000000,,03
   21-11-2023 14:29,81442545,WHFWL180038545,AEL,0.000000,0.000000,0.000000,,03
   21-11-2023 14:29,81440874,WHFWL180036874,AEL,0.000000,0.000000,0.000000,,03
   21-11-2023 14:29,81440873,WHFWL180036873,AEL,0.000000,0.000000,0.000000,,03
   ```

   

#### Read Meter Data 读表数据

> 说明 ( 该读表数据可能只能自动生成，ACK 文件总不是自己写的 )

前面有配置表用来配置设备，它会生成表数据文件，但是这次直接请求表数据。

- 存放文件夹: `METER_READ_ACK_FOLDER`
- 自动生成相应的 ACK 文件。



#### METER_READ_ACK_FOLDER 待验证

- 在 METER_READ_OUT_FOLDER 中生成的表数据文件，应当在它的 ACK 文件夹下放入对应的 ACK 文件，表示已经正确读到表数据，**之后才会在 BACKUP_FOLDER** 文件夹中生成备份文件。



#### 疑问点：

- 使用错误的 csv 文件名，但是生成了正确的ACK 文件 

  ( 在 ON_DEMAND_READ_REQ_IN 中使用错误文件名, 在 ON_DEMAND_READ_REQ_IN_ACK 中生成正确 ACK 文件 )

  参考文档中的格式

  ![image-20231121143208000](WMBUS%20%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%B5%8B%E8%AF%95%E7%8E%B0%E8%B1%A1%E8%AE%B0%E5%BD%95.assets/image-20231121143208000.png)

  1. 使用的错误文件名字 `DCWA19088_ONEDEMAND_2111231410_REQ.csv`

  2. 生成的正确的 ACK 文件 `DCWA19088_ONDEMAND_2111231414_REQ_ACK.csv`

     正确的 ACK 文件中的内容 

     ```bash
     DCWA19088,10.0.0.233,ESY,21-11-2023 14:14,00
     ```

- 在 CONFIGURATION_OUT_FLOADER 文件夹中，设置表配置文件，如果配置和原来配置一样，那么它就不会生成 ACK 文件 ? ( 测试如此，不知这个现象是否正常 )

- 如果得到正确的 ACK 文件之后？它会自动删除 ACK 文件？

- 文件吞吐量大时，设备是否会重启

---

- 1. 如果在 `CONFIGURATION_IN_FOLDER` 中存放文件，那么过一段时间会在 `CONFIGURATION_OUT_FOLDER` 中生成对应文件.

     > CONF_IN_FOLDER

     文件名:  

     TEST00021_CONF_SETUP_VER_2411231450.csv

     TEST00023_CONF_SETUP_VER_2411231450.csv

     TEST00024_CONF_SETUP_VER_2411231450.csv

     ```bash
     DCWA00001,10.0.0.233,123,24-11-2023 14:50
     20713171,WHFWL200065004,ITL,01
     74897902,WHFWL200005721,KAL,01
     81442545,WHFWL180038545,AEL,01
     
     -------------------------------------------
     DCWA00001,10.0.0.233,123,24-11-2023 14:50
     20713172,WHFWL200065004,ITL,01
     74897905,WHFWL200005721,KAL,01
     81442546,WHFWL180038545,AEL,01
     ------------------------------------------
     ... 我放了好多文件进去，有8个之多。
     备注: 状态码 01 代表 Active 加入新表，如果已存在那也一样设置 Active flag 继续读表
     ```

     > CONF_OUT_FOLDER

     文件名: 

     DCWA00001_CONF_VER_2411231503_ACK.csv

     DCWA00001_CONF_VER_2411231504_ACK.csv

     ```bash
     DCWA00001,10.0.0.233
     24-11-2023 15:03,20713172,WHFWL200065004,ITL,01,01
     24-11-2023 15:03,74897905,WHFWL200005721,KAL,01,01
     24-11-2023 15:03,81442546,WHFWL180038545,AEL,01,01
     24-11-2023 15:03,20713173,WHFWL200065004,ITL,01,01
     24-11-2023 15:03,74897904,WHFWL200005721,KAL,01,01
     24-11-2023 15:03,81442547,WHFWL180038545,AEL,01,01
     24-11-2023 15:03,20713179,WHFWL200065004,ITL,01,01
     24-11-2023 15:03,74897909,WHFWL200005721,KAL,01,01
     24-11-2023 15:03,81442549,WHFWL180038545,AEL,01,01
     24-11-2023 15:03,20713171,WHFWL200065004,ITL,01,01
     24-11-2023 15:03,74897902,WHFWL200005721,KAL,01,01
     24-11-2023 15:03,81442545,WHFWL180038545,AEL,01,01
     ------------------------------------------------
     DCWA00001,10.0.0.233
     24-11-2023 15:04,20713172,WHFWL200065004,ITL,01,01
     24-11-2023 15:04,74897905,WHFWL200005721,KAL,01,01
     24-11-2023 15:04,81442546,WHFWL180038545,AEL,01,01
     24-11-2023 15:04,20713173,WHFWL200065004,ITL,01,01
     24-11-2023 15:04,74897904,WHFWL200005721,KAL,01,01
     24-11-2023 15:04,81442547,WHFWL180038545,AEL,01,01
     24-11-2023 15:04,20713179,WHFWL200065004,ITL,01,01
     24-11-2023 15:04,74897909,WHFWL200005721,KAL,01,01
     24-11-2023 15:04,81442549,WHFWL180038545,AEL,01,01
     24-11-2023 15:04,20713171,WHFWL200065004,ITL,01,01
     24-11-2023 15:04,74897902,WHFWL200005721,KAL,01,01
     24-11-2023 15:04,81442545,WHFWL180038545,AEL,01,01
     
     ```

  2. 根据之前的记录，如果在 `CONFIGURATION_OUT_FOLDER` 放入文件，它也会在 OUT 文件夹中中生成 ACK 文件，但是！！ 

     它的状态码中 如果表存在会正常为 01，

     ```bash
     TEST00001,10.10.10.233
     20-11-2023 18:34,20713171,WHFWL20006504,ITL,01,01
     ```

     如果表不存在就如下状态

     ```bash
     DCWA00001,10.0.0.233
     21-11-2023 11:38,20713173,WHFWL200065004,ITL,02,01
     21-11-2023 11:38,74897904,WHFWL200005721,KAL,02,01
     21-11-2023 11:38,81442547,WHFWL180038545,AEL,02,01
     ----------------------------------------------------
     备注: 
     倒数第二个的质量状态码 02 表示仪表未注册(如果删除删除)。
     倒数第一个的标志状态未 01 表示活跃
     ```

- `ON_DEMAND_READ_OUT` 文件夹名称生成错误

  > 实际生成

  ![image-20231124153134380](WMBUS%20%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%B5%8B%E8%AF%95%E7%8E%B0%E8%B1%A1%E8%AE%B0%E5%BD%95.assets/image-20231124153134380.png)

  > 应当生成( 下图为官方文档中的实例 )

  ![image-20231124153149507](WMBUS%20%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%B5%8B%E8%AF%95%E7%8E%B0%E8%B1%A1%E8%AE%B0%E5%BD%95.assets/image-20231124153149507.png)

- 偶尔打开文件的时候会报错

  ![image-20231124164053137](WMBUS%20%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%B5%8B%E8%AF%95%E7%8E%B0%E8%B1%A1%E8%AE%B0%E5%BD%95.assets/image-20231124164053137.png)

  ---

- 容易重连，但是EVENT 并没有提示开机。可能是断网的原因

  ![image-20231124174831067](WMBUS%20%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%B5%8B%E8%AF%95%E7%8E%B0%E8%B1%A1%E8%AE%B0%E5%BD%95.assets/image-20231124174831067.png)

  ![image-20231124174841149](WMBUS%20%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%B5%8B%E8%AF%95%E7%8E%B0%E8%B1%A1%E8%AE%B0%E5%BD%95.assets/image-20231124174841149.png)

  ![image-20231124174643737](WMBUS%20%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%B5%8B%E8%AF%95%E7%8E%B0%E8%B1%A1%E8%AE%B0%E5%BD%95.assets/image-20231124174643737.png)

- WMBUS 网关重启问题：

  现象：在 ON_DEMAND 中 REQ 请求文件生成的第一次 ACK 文件时不会重启，此时 REQ 请求的 文件不会被删除，但是随着它第二次生成(更新) ACK 文件时网关就会重启( 这部分可以根据 ACK 文件名的时间和 EVENT OUT 事件进行验证 )，此时第二次生成 ACK 时 REQ 也可能不会被删除，第三次生成之后就会被删除。
  
- 放入文件之后每次登录 SFTP 时会导致网关串口掉线。

  在该版本中：当 ON_DEMAND_IN 放入文件之后，ACK 中生成时会导致重启。而此时，重启会导致登不上去，且掉串口



---

>2023 -11-30  



>-> ON_DEMAND_READ_IN 

该文件夹下存放12个配置文件

现象:

1. 仅仅会在 ON_DEMAND_READ_REQ_ACK 生成 3 个 ACK 文件。

   ![image-20231130110836128](WMBUS%20%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%B5%8B%E8%AF%95%E7%8E%B0%E8%B1%A1%E8%AE%B0%E5%BD%95.assets/image-20231130110836128.png)

2. ON_DEMAND_READ_REQ 中存放的 12 个文件，会被删除到 9 个，然后刷新删到 7 个。隔了挺长一段时间之后设备重启，且重连不上。

3. 新现象: 放入12 个文件之后等 10s 左右立即死机。



> 测试不同功能码的情况下是否正常工作

- 测试 标识码 03 &04

  理论现象: 

  在此种情况下，无论 DCU 是否已接收到库存详细信息，DCU 都应该在 ACK 文件下设置标志位 03(错误)。



- 测试标识码 02

  · case1:	DCU 没有需要删除的电表的相关库

  ​	DCU 会在 ACK 文件中记录标志位为 02 。( 在ACK 中，该标志位表示 " 设备未注册 " )

  · case2:	DCU 找到了那个不幸的表

  ​	DCU 会删掉表，并在 ACK 中标志位记录为 00 , 表示成功删除

  

- 测试标识码 05

  · case1: DCU 未收到 MSN , USN 和 制造商代码的库存信息时

  ​	DCU 应丢弃表的加密密钥并在 ACK 文件中

  · case2: DCU 收到 MSN , USN 和 制造商代码的库信息时，

  ​	DCU 就会和仪表进行通信，就会生成对应的 ACK 文件，其中由 " 状态码 " 来表示是否能连接到表



- CONFIGRATION_IN_FOLDER 放多个文件之后，只有一个文件会成功晋级，让 OUT 文件夹输出一个 ACK 文件。

  1. 放入如下图 ' CONFIGURATION_IN ' 的文件，文件内容和 OUT 出来的文件一致

     ![image-20231130155212785](WMBUS%20%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%B5%8B%E8%AF%95%E7%8E%B0%E8%B1%A1%E8%AE%B0%E5%BD%95.assets/image-20231130155212785.png)

     

  2.  ' CONFIGRATION_OUT ' 出来的文件如下，

     ![image-20231130155307557](WMBUS%20%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%B5%8B%E8%AF%95%E7%8E%B0%E8%B1%A1%E8%AE%B0%E5%BD%95.assets/image-20231130155307557.png)

  3.  ' METER_READ_OUT ' 文件夹会生成表的数据文件，如下图。

     ![image-20231130155410765](WMBUS%20%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%B5%8B%E8%AF%95%E7%8E%B0%E8%B1%A1%E8%AE%B0%E5%BD%95.assets/image-20231130155410765.png)

  > ASK : 
  >
  > 1. 存放多个配置文件，如何确实是哪个文件生效？
  > 2. 待测 它是否和 ON_DEMAND_REQ 有关?

- ON_DEMAND_REQ 存入的数量问题，放入 48 个文件导致卡死

- METER_READ_ACK 文件进行读表

  

- CONFIGURATION_IN 文件夹放入文件， OUT 生成文件，然后 CONFIGRATION_IN 里的文件会被清除。

  随后过几分钟( 10分钟的样子 ) METER READ_OUT_FOLDER 就会生成读表文件。

  注意: CONFIGRATION_OU  生成的文件一直不会被删除。



-- -

> 2023-12-6

新版本SFTP 测试





##### Article END









