### BL0956 芯片替换到BL0906 电能计量芯片 



- BL0956 的寄存器修改为 BL0906 进行替换







- 查找芯片datasheet



#### 对于电量测量芯片



- 以设备直流初始化指令作为参考

  CA9E555500B7

  



#### 测试方法

&emsp;&emsp;485总线和724芯片通信，将收到的串口指令转发给电量计芯片，724再读取电量计芯片的寄存器，然后再转发回485总线的芯片。

- 485 通信使用 uart1





- 模块和电量计使用 uart3





- 多路引脚 mapping

  ```bash
  
  # 对于板子的 1路继电器，对应的是芯片通道4 的引脚
  
  #
  
  #
  
  
  
  ```

  

- 功率记录

  | 测量电压 | 测量电流 | 测量功率 |  电源电流   |
  | :------: | :------: | :------: | :---------: |
  |  12.17V  | 0.16522A | 3.4919W  |      /      |
  | 12.189V  | 0.12704A | 2.6837W  | 0.21A * 12V |
  | 12.141V  | 0.2285A  | 4.80704W | 0.30A * 12V |
  |  12.05V  |  0.4619  |  9.655W  | 0.5A * 12V  |
  | 12.1883V | 0.12713A | 2.6847W  | 0.21A * 12V |
  |          |          |          |             |

  - 电源不带负载的情况电流是0.09 ~0.11A 区间



#### 指令的整理

- 写入命令 -> 初始化指令：( 在后面需要将用得到的指令做成一个table  )

  ```lua
  
  -- 设备复位之后再进行初始化
  local devrst = {
  	-- 串口写寄存器关闭保护
      -- 写入" 用户写保护寄存器 "
  	"CA9E555500B7"   -- 最后一个字节: ((ADDR + DATA_L + DATA_M + DATA_H) & 0xFF) 再按位取反
  	
  	-- 注意该寄存器在0906 芯片中不存在
      -- 脉冲输出通道选择1，无功选全波
      -- 用户模式选择寄存器1 '00 04 1E' => 0000 0000 0000 0100 0001 1110  --全波，通道1-4
  	-- "CA961E040047"   
      
      -- 如果不能同时多选的话，那就执行多次，同一个寄存器分4次写入电流通道N。
  	"CA9801000165"    		-- addr(98) 用户寄存器，电流1    01 00 01  => 01 00 01 65
  	"CA9802000164"			-- addr(98) 用户寄存器，电流2    01 00 02  => 02 00 01  64
      "CA9803000163"			-- addr(98) 用户寄存器，电流3    01 00 03  => 03 00 01 63
      "CA9804000162"			-- addr(98) 用户寄存器，电流4
      
  
  	-- 读一下 '用户写保护设置寄存器'
  	"359E" 
  	
  	-- 9F 的软复位寄存器  -- 与0956一致
  	"CA9F5A5A5A52"
  	
  	
  	
  	-- 电参数运算系统复位，Reg3B~2F 清零
  	"CA9F5A5A5A52"
  	
  
  
  }
  
  
  
  -- 设备直流初始化指令
  local devinit_dir = {
      "CA9E555500B7", -- 设备关闭用户写保护
      "CA961E040047", -- 用户模式寄存器1  00 04 1E交流全波 1-4通道+电压通道  (波形可能不重要，并不使用它)
      
      
      
      "CA97A882221C", -- 用户模式寄存器2  22 82 A8 交流全波，1-6通道+电压通道全是0b10
      
      
      
      "CA6030333309", -- 电流通道16倍增益，电压通道1倍增益
      				-- 通道PGA增益调整寄存器 33 33 30 电流通道1-4 为16倍增益 (电压通道1倍增益)
      
      
      "CA6133330335", -- 通道PGA增益调整寄存器 03 33 33 电流通道5-6 开为16倍增益
      
      
      
      -- "CA8A6C050004", -- 防潜动阈值设置，电流有效值设置8mA以下切除到零，有功功率设置2W以下切除到零;阈值大小根据实际情况设置
      -- "CA8843010033", --
      -- "CA9DFF1F0044", -- 电能脉冲读后清零设置,Reg3B~2F设置为读后清零
      -- "CA9F5A5A5A52", -- 电参数运算系统复位，Reg3B~2F清零
      "CA9E00000061" -- 关闭写保护
  }
  ```

  

- 寄存器数据指令

  ```lua
  
  
  
  
  ```

  

#### 对于0906芯片的理解

- PGA 模块放大器的放大倍率和得到的电流结果没有必然的关系。它只存在于芯片的寄存器存放数据之前的运算。(可能可精度有关系，但是和具体的值应该差别不大)









#### 遇到的解析的问题

- 函数问题
  1. 回调函数不能有() ，比如uart.on(uid_485,"receive",u_read)  中u_read 函数名不能有括号
  2. 串口发送函数的停止位必须为2，不然会出现乱码的BUG





- 字段的数据解析

  ![image-20230808173223346](https://dearliao.oss-cn-shenzhen.aliyuncs.com/Note/picture/202308111741093.png)

  ![image-20230808173240860](https://dearliao.oss-cn-shenzhen.aliyuncs.com/Note/picture/202308111741095.png)

  ```lua
  "CA60 30 33 33 09", -- 电流通道16倍增益，电压通道1倍增益`&ensp;根据文档数据格式说明，
  --[[
  	CA : 表示对芯片的 写操作
  	60 : 地址位，文档提示 '校表寄存器(外部写)' 
  	30 33 33 : 数据位，但是注意大端小端问题，这边分析,正确读法应当 '33 33 30'，最后一位是电压通道，刚好匹配电压通道 1倍增益，电流通道 16倍增益。注意 4-7位是没有功能的
  	09 : 校验位，根据UART 的数据格式 说明的。文档最后有这个说明
  ]]
  
  -- 不是很确定大端小端的问题，后续测试得结论再改该文档
  ```

  

  



























