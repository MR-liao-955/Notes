## 电子背包通讯协议

版本: `v1.6`

| 版本 | 更新历史                                                                           | 时间       |
| ---- | ---------------------------------------------------------------------------------- | ---------- |
| V1.6 | 新增硬件版本寄存器, 调整 OTA 寄存器地址和数据定义, 调整振动检测参数, 修改示例指令  | 2023.12.5  |
| V1.5 | 规范寄存器长度, 调整 OTA 寄存器数据定义                                            | 2023.12.4  |
| V1.4 | 新增固件版本号寄存器, 新增 OTA 寄存器帧定义,新增振动检测寄存器, 新增三轴数据寄存器 | 2023.12.4  |
| V1.3 | 添加 CRC16 说明                                                                    | 2023.12.2  |
| V1.2 | 使用 10H 指令替代 06H                                                              | 2023.11.28 |

采用 `modbus` 协议, 校验使用 `CRC16_Modbus`, 默认地址为 `0x01`
串口参数: `115200 / 8 / N / 1`

[modbus 协议参照](https://blog.csdn.net/qq_21805743/article/details/120560226)

### 寄存器说明

| 地址(Hex) | 长度(byte) | 属性 | 参数名            | 描述         | 备注                                                                        |
| --------- | ---------- | ---- | ----------------- | ------------ | --------------------------------------------------------------------------- |
| 0x00      | 2          | R    | 触发上报          |              | 参照触发上报 Bit 位定义表                                                   |
| 0x02      | 4          | RW   | 脉冲计数值        |              | 可以写入计数值                                                              |
| 0x06      | 2          | RW   | 数据上报周期      | 默认值 5 min | 单位为 min, 值域范围为 1-65534, 入网后主动开启                              |
| 0x08      | 2          | R    | 电池电压          |              | 单位为 mV, 值域为 0 - 65535, 无效值为 0xFFFF                                |
| 0x0A      | 2          | R    | 模块温度          |              | 实际温度扩大 10 倍, 263 = 26.3, 值域为 0 - 65535, 无效值为 0xFFFF           |
| 0x0C      | 2          | R    | 硬件 + 固件版本号 |              | 硬件 + 固件版本号, 高 8 位硬件版本 + 低 8 位固件版本                        |
| 0x0E      | 2          | RW   | 振动检测参数      |              | 振动检测参数, 0x0000 关闭振动检测, 否则为 1byte 灵敏度 + 1 byte 检测周期(s) |
|           |            |      |                   |              |                                                                             |
| 0x10      | 2          | W    | 消息确认          |              | 上报数据后由服务器下发确认指令                                              |
| 0x12      | 2          | R    | 入网状态          |              | 入网状态, 0 未入网 / 1 已入网                                               |
| 0x14      | 8          | RW   | deveui            |              | 入网 deveui, 默认值 0x00 0x00 0x00 0x00 ...                                 |
| 0x1C      | 8          | RW   | appeui            |              | 入网 appeui, 默认值 0x00 0x00 0x00 0x00 ...                                 |
| 0x24      | 16         | RW   | appkey            |              | 入网 appkey, 默认值 0x00 0x00 0x00 0x00 ...                                 |
| 0x34      | 4          | RW   | 时间戳            |              | 设备 RTC 时间戳                                                             |
| 0x38      | 8          | R    | 三轴数据          |              | 设备三轴角度数据, 倾斜角度 + XYZ 每个轴数据                                 |
|           |            |      |                   |              |                                                                             |
| 0x50      | 4          | W    | 开始 OTA          |              | 开始准备 OTA 升级, 下发升级 2byte 硬件版本 + 2byte 固件大小                 |
| 0x54      | 2          | W    | 结束 OTA          |              | 固件传输完成, 可以开始升级                                                  |
| 0x56      | 130        | W    | OTA 数据帧        |              | 下发固件数据，包序号 2byte + 数据段 128byte                                 |

- 触发上报 `bit` 位定义表

| Bit7 | ... | Bit3     | Bit2     | Bit1       | Bit0     |
| ---- | --- | -------- | -------- | ---------- | -------- |
| ...  | ... | 三轴触发 | 按键触发 | 定时器触发 | 上电触发 |

- 对应 `bit` 为 `1` 代表为触发方式, 所有触发上报的 `bit` 位进休眠后清除，下一次再重新检测是什么方式

| 触发类型   | 备注                         |
| ---------- | ---------------------------- |
| 上电触发   | 设备外部断电上电触发上报数据 |
| 定时器触发 | 休眠定时器触发上报数据       |
| 按键触发   | 按键唤醒触发上报数据         |
| 三轴触发   | 三轴唤醒触发上报数据         |

### 通讯示例

- 设备数据解析

```shell
# 查询设备数据
01 03 00 00 00 08 CRC16
# 查询设备数据回复 (自动唤醒后上报服务器也是该格式)
01 03 10 0001 1234 5678 0005 0E10 0109 0102 12 34 CRC16

01 03 10 固定数据头

0001: 触发上报类型: 上电触发上报数据
1234 5678 : 脉冲计数值: 0x12345678 = 305419896 转
0005: 上报周期: 5min
0E10: 电池电压: 0x0E10 = 3600mV = 3.6v
0109: 模块温度: 0x0109 = 265 = 26.5
01 02: 版本号: 硬件版本 0x01 = v1, 固件版本号 0x02 = v2
12 34: 振动检测参数: 0x12 是灵敏度参数, 0x34 检测周期
```

- 交互指令枚举

```shell
# 查询设备数据
01 03 00 00 00 08 CRC16
# 查询设备数据回复 (自动唤醒后上报服务器也是该格式)
01 03 10 0001 1234 5678 0005 0E10 0109 0102 12 34 CRC16

# 设置脉冲计数值
01 10 00 02 00 02 04 12 34 56 78 CRC16
# 设置脉冲计数值回复
01 10 00 02 00 02 CRC16

# 设置设备上报周期
01 10 00 06 00 01 02 33 33 CRC16
# 设置设备上报周期回复
01 10 00 06 00 01 CRC16

# 设置设备休眠 (服务器收到上报后下发该指令, 收到后开始休眠, 等待下一轮唤醒)
01 10 00 10 00 01 02 00 01 CRC16
# 设置设备休眠回复
01 10 00 10 00 01 CRC16

# 查询入网状态
01 03 00 12 00 01 CRC16
# 查询入网状态回复
01 03 02 00 01 CRC16

# 设置 deveui
01 10 00 14 00 04 08 01 02 03 04 05 06 07 08 CRC16
# 设置 deveui 回复
01 10 00 14 00 04 CRC16
# 查询 deveui
01 03 00 14 00 04 CRC16
# 查询 deveui 回复
01 03 08 01 02 03 04 05 06 07 08 CRC16

# 设置 appeui
01 10 00 1C 00 04 08 01 02 03 04 05 06 07 09 CRC16
# 设置 appeui 回复
01 10 00 1C 00 04 CRC16
# 查询 appeui
01 03 00 1C 00 04 CRC16
# 查询 appeui 回复
01 03 08 01 02 03 04 05 06 07 08 CRC16

# 设置 appkey
01 10 00 24 00 08 10 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 01 CRC16
# 设置 appkey 回复
01 10 00 24 00 08 CRC16
# 查询 appkey
01 03 00 24 00 08 CRC16
# 查询 appkey 回复
01 03 10 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 01 CRC16

# 设置时间戳 (2023-11-25 10:00:00 = 1700877600 = 0x65615520)
01 10 00 34 00 02 04 65 61 55 20 CRC16
# 设置时间戳回复
01 10 00 34 00 02 CRC16
# 查询时间戳
01 03 00 34 00 02 CRC16
# 查询时间戳回复
01 03 04 65 61 55 20 CRC16

# 查询三轴数据
01 03 00 38 00 04 CRC16
# 查询三轴数据回复
01 03 08 11AA 0001 0002 0003 CRC16
# 数据解析
0x11AA: 倾斜角度: 45.22 度
0x0001: X 轴数据
0x0002: Y 轴数据
0x0003: Z 轴数据
```

- 错误码回复定义

```shell
# 指令码错误
01 93 01 CRC16

# 寄存器错误
01 93 02 CRC16

# CRC 校验错误
01 93 03 CRC16
```

### OTA 说明

```shell
# 开始升级(2byte 硬件版本 + 2byte 固件大小)
01 10 00 50 00 02 04 0002 1234 CRC16
# 开始升级回复
01 10 00 50 00 02 CRC16
# 解析
0x0002: 硬件版本 v2
0x1234: 固件大小: 4660 byte

# 结束升级
01 10 00 54 00 01 02 00 01 CRC16
# 结束升级回复
01 10 00 54 00 01 CRC16

# OTA 数据帧(包序号 2byte + 数据段 128byte)
01 10 00 56 00 41 82 0001 12 34 .... CRC16
# OTA 数据帧回复
01 10 00 56 00 41 CRC16

0001: 包序号: 第1个包, 后续依次递增
1234...: 数据段, 定长 128, 最后一个包除外
```

- `OTA` 错误码回复定义

```shell
# OTA 查询错误，返回差错码 0x90，异常码 0x02
[20:02:02.424]发→◇01 10 00 50 00 02 04 00 02 12 34 5A 24 □
[20:02:02.429]收←◆01 90 02 CD C1 

# 升级状态异常(未收到开始升级包指令)
01 94 01 CRC16

# 包序号错误(序号不连续, 比如上一帧收到包号为2, 当前帧收到序号为4, 说明有丢包, 服务器收到后会将帧序号回退, 重发一次序号3的数据帧)
01 94 02 CRC16

# 帧数据错误(CRC 校验不过)
01 94 03 CRC16

# 硬件版本错误
01 94 04 CRC16
```
