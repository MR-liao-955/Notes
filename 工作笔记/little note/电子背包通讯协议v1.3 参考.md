## 电子背包通讯协议

版本: `v1.3`

采用 `modbus` 协议, 校验使用 `CRC16_Modbus`, 默认地址为 `0x01`
串口参数: `115200 / 8 / N / 1`

[modbus 协议参照](https://blog.csdn.net/qq_21805743/article/details/120560226)

### 寄存器说明

| 地址(Hex) | 长度 | 属性 | 参数名       | 描述         | 备注                                                              |
| --------- | ---- | ---- | ------------ | ------------ | ----------------------------------------------------------------- |
| 0x01      | 1    | R    | 报警信息     |              | 参照报警信息 Bit 位定义表                                         |
| 0x02      | 4    | RW   | 脉冲计数值   |              | 可以写入计数值                                                    |
| 0x06      | 2    | RW   | 数据上报周期 | 默认值 5 min | 单位为 min, 值域范围为 1-65534, 入网后主动开启                    |
| 0x08      | 2    | R    | 电池电压     |              | 单位为 mV, 值域为 0 - 65535, 无效值为 0xFFFF                      |
| 0x0A      | 2    | R    | 模块温度     |              | 实际温度扩大 10 倍, 263 = 26.3, 值域为 0 - 65535, 无效值为 0xFFFF |
|           |      |      |              |              |                                                                   |
| 0x10      | 1    | W    | 消息确认     |              | 上报数据后由服务器下发确认指令                                    |
| 0x11      | 1    | R    | 入网状态     |              | 入网状态, 0 未入网 / 1 已入网                                     |
| 0x12      | 8    | RW   | deveui       |              | 入网 deveui, 默认值 0x00 0x00 0x00 0x00 ...                       |
| 0x1A      | 8    | RW   | appeui       |              | 入网 appeui, 默认值 0x00 0x00 0x00 0x00 ...                       |
| 0x22      | 16   | RW   | appkey       |              | 入网 appkey, 默认值 0x00 0x00 0x00 0x00 ...                       |
| 0x32      | 4    | RW   | 时间戳       |              | 设备 RTC 时间戳                                                   |

- 报警信息 Bit 位定义表

| Bit7     | ... | Bit3     | Bit2     | Bit1     | Bit0     |
| -------- | --- | -------- | -------- | -------- | -------- |
| ...      | ... | ...      | ...      | 防拆报警 | 按键事件 |

- 对应 `Bit` 为 `1` 代表出现该事件

| 事件     | 备注                                 |
| -------- | ------------------------------------ |
| 按键事件 | 按键按下时触发一次, 上报后重置       |
| 防拆报警 | 三轴异常时产生, 恢复后重置           |

### 通讯示例

- 设备数据解析

```shell
# 查询设备数据
01 03 00 01 00 0B CRC16
# 查询设备数据回复 (自动唤醒后上报服务器也是该格式) 		
01 03 0B 01 1234 5678 0005 0E10 0109 CRC16
									
01 03 0B 固定数据头

01 : 报警信息: 按键事件
1234 5678 : 脉冲计数值: 0x12345678 = 305419896 转
0005: 上报周期: 5min
0E10: 电池电压: 0x0E10 = 3600mV = 3.6v
0109: 模块温度: 0x0109 = 265 = 26.5
```

- 交互指令枚举

```shell
# 查询设备数据
01 03 00 01 00 0B CRC16
# 查询设备数据回复 (自动唤醒后上报服务器也是该格式)
01 03 0B 01 1234 5678 0005 0E10 0109 CRC16

# 设置脉冲计数值
01 10 00 02 00 02 04 12 34 56 78 CRC16				
# 设置脉冲计数值回复
01 10 00 02 00 02 CRC16 	 # 有误，如若改为『01 10 00 02 00 02 04 00 00 00 00』则有回复 ！！

# 设置设备上报周期
01 10 00 06 00 01 02 33 33 CRC16
# 设置设备上报周期回复
01 10 00 06 00 01 CRC16		# 有误，不符合 modbus 协议规范，

# 设置设备休眠 (服务器收到上报后下发该指令, 收到后开始休眠, 等待下一轮唤醒) (休眠最大超时 15s)
01 10 00 10 00 01 02 00 01 CRC16   #直接休眠，别的命令不起作用
# 设置设备休眠回复				# 不知如何检测，
01 10 00 10 00 01 CRC16

# 查询入网状态
01 03 00 11 00 01 CRC16  # 返回 00 
# 查询入网状态回复
01 03 01 01 CRC16  			# modbus 格式有误

# 设置 deveui
01 10 00 12 00 04 08 01 02 03 04 05 06 07 08 CRC16
# 设置 deveui 回复
01 10 00 12 00 04 CRC16		 # modbus 格式有误
# 查询 deveui
01 03 00 12 00 08 CRC16
# 查询 deveui 回复
01 03 08 01 02 03 04 05 06 07 08 CRC16   # 回复 01 83 02 C0 F1 ,说明有误

# 设置 appeui
01 10 00 1A 00 04 08 01 02 03 04 05 06 07 08 CRC16
# 设置 appeui 回复
01 10 00 1A 00 04 CRC16		 		# modbus 格式有误
# 查询 appeui
01 03 00 1A 00 08 CRC16
# 查询 appeui 回复
01 03 08 01 02 03 04 05 06 07 08 CRC16		#modbus 格式有误

# 设置 appkey
01 10 00 22 00 08 10 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 01 CRC16
# 设置 appkey 回复
01 10 00 22 00 08 CRC16				# 格式有误
# 查询 appkey
01 03 00 22 00 10 CRC16
# 查询 appkey 回复
01 03 10 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 01 CRC16		# 格式有误

# 设置时间戳 (2023-11-25 10:00:00 = 1700877600 = 0x65615520)
01 10 00 32 00 02 04 65 61 55 20 CRC16
# 设置时间戳回复
01 10 00 32 00 02 CRC16			# 格式有误
# 查询时间戳
01 03 00 32 00 04 CRC16		
# 查询时间戳回复
01 03 04 65 61 55 20 CRC16 			# 
```

- 错误码回复定义

```shell
# 指令错误
01 93 01 80 F0

# 寄存器错误
01 93 02 C0 F1

# CRC 校验错误
01 93 03 01 31
```

