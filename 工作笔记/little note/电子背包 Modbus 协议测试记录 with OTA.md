### 电子背包 Modbus 协议测试记录 with OTA

[toc]

> modbus 协议参考文档

[参考文档](https://blog.csdn.net/qq_21805743/article/details/120560226)

#### 设置记录:

- 查询设备数据

  ```bash
  # 输入查询指令。 03->功能码, 0000->寄存器起始地址, 0010->寄存器数目
  01 03 00 00 00 10 CRC16
  # ret
  01 03 20 02 00 00 00 00 00 00 00 0C 5A 00 DB 01 01 00 00 00 00 00 00 00 00 00 00 00 00 01 02 01 02 01 02 20 0A 
  #### ret 说明
  #前缀
  03	功能码
  20	字节数 2*N
  #后续即为寄存器的值
  02 00		触发上报
  00 00 00 00 脉冲计数值
  00 00 		数据上报周期
  0C 5A 		电池电压 0x0C5A=> 3162   3.162V
  00 DB		模块温度 0xDB=> 219  21.9℃
  01 01 		硬件 + 固件版本号
  00 00 		振动检测参数 0x0000 关闭振动检测，否则为 1byte 灵敏度 + 1byte 检测周期
  
  
  ```

- 设置脉冲计数值

  ```bash
  # 地址码 0x02 长度: 4byte
  01 10 00 02 00 02 04 12 34 56 78 CRC
  ### send 说明
  10		功能码 "写"
  00 02 	寄存器起始地址
  00 02 	寄存器数目
  04		字节数 2*N (二倍于寄存器数目)
  1234 5678 寄存器的值
  # ret 
  01 10 00 02 00 02 E0 08
  
  ### 查询脉冲计数值
  [15:33:36.065]发→◇01 03 00 02 00 04 E5 C9 □
  [15:33:36.083]收←◆01 03 08 00 00 56 78 00 00 0C A0 3C 93 
  
  
  ```

- 设置设备上报周期

  ```bash
  # 设备上报周期
  01 10 00 06 00 01 02 33 33
  # return
  [16:47:41.183]发→◇01 10 00 06 00 01 02 33 33 F2 D3 □
  [16:47:41.192]收←◆01 10 00 06 00 01 E1 C8 
  
  # 再次查询
  01 03 00 06 00 01
  
  ### !! 查询的结果存在异常，该寄存器是否存在问题
  [16:54:04.022]发→◇01 03 00 06 00 01 64 0B □
  [16:54:04.037]收←◆01 03 02 00 00 B8 44 
  ```

- 测试 0x12 的入网状态是否能写入 ( 该寄存器属性为 R, 一般情况应该写不进去，会返回错误码应该 )。

  ```bash
  # 往入网状态写入 11 11
  [17:13:29.319]发→◇01 10 00 12 00 01 02 11 11 69 7E □
  [17:13:29.325]收←◆01 10 00 12 00 01 A1 CC 
  # 写完再读
  [17:16:21.675]发→◇01 03 00 12 00 01 24 0F □
  [17:16:21.689]收←◆01 03 02 00 00 B8 44 
  #### res: 未能写入
  # 再次查询设备寄存器的信息 (未发现 11 11)，因此判断未能写入
  [17:18:26.242]发→◇01 03 00 00 00 10 44 06 □
  [17:18:26.257]收←◆01 03 20 00 04 00 00 00 00 00 00 0C 86 00 E7 01 01 00 00 00 00 00 00 07 09 00 00 01 02 03 04 05 06 07 08 2E 0C 
  ```

  

- 读 DevEUI、AppEUI、AppKEY

  ```bash
  # deveui
  01 03 00 14 00 08 CRC
  # return 理论应当返回的字节数为 8 byte
  [16:15:47.091]发→◇01 03 00 14 00 08 04 08 □
  [16:15:47.107]收←◆01 03 10 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 E4 59 
  
  # appeui
  01 03 00 1C 00 08 CRC
  # return  返回字节理论为 16 byte
  [16:18:39.734]发→◇01 03 00 1C 00 08 85 CA □
  [16:18:39.749]收←◆01 03 10 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 E4 59 
  
  # appkey
  01 03 00 24 00 10 CRC
  # return 返回字节理论上为 16 字节
  [16:19:32.751]发→◇01 03 00 24 00 10 04 0D □
  [16:19:32.766]收←◆01 03 20 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 54 58 23 28 00 00 00 00 00 00 00 00 00 00 DD ED
  
  ###########################  设置 EUI 三组数据 #####################
  # deveui
  01 10 00 14 00 04 08 01 02 03 04 05 06 07 08 CRC
  # return
  [16:21:05.621]发→◇01 10 00 14 00 04 08 01 02 03 04 05 06 07 08 76 8E □
  [16:21:05.637]收←◆01 10 00 14 00 04 81 CE 
  
  # appeui
  01 10 00 1C 00 04 08 01 02 03 04 05 06 07 09 CRC
  # return
  [16:21:50.980]发→◇01 10 00 1C 00 04 08 01 02 03 04 05 06 07 09 56 91 □
  [16:21:50.993]收←◆01 10 00 1C 00 04 00 0C 
  
  # appkey
  01 10 00 24 00 08 10 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 01 CRC
  # return
  [16:22:22.667]发→◇01 10 00 24 00 08 10 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 01 39 E9 □
  [16:22:22.677]收←◆01 10 00 24 00 08 81 C4 
  
  ######################### 再次查询 ######################
  # deveui
  [16:23:35.233]发→◇01 03 00 14 00 04 04 0D □
  [16:23:35.248]收←◆01 03 08 05 06 07 08 01 02 03 04 72 91 
  # appeui
  [16:24:13.707]发→◇01 03 00 1C 00 04 85 CF □
  [16:24:13.723]收←◆01 03 08 05 06 07 09 00 00 01 02 6E 0F 
  # appkey
  [16:24:35.130]发→◇01 03 00 24 00 08 04 07 □
  [16:24:35.145]收←◆01 03 10 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 01 00 00 6A F7 
  
  ```

  

#### 问题点

- 读设备数据存在获取字节长度异常。

  ![image-20231205160859363](https://dearliao.oss-cn-shenzhen.aliyuncs.com/Note/picture/202404081000911.png)

  1. modbus 协议返回的数据长度有误，20 表示字节长度，而实际返回的长度为 32 byte .
  2. 后续的字节不知为何物 , 01 01 00 00 之后的 16 字节数据不确定是何种问题。

- 写入脉冲计数值寄存器有误。

  1. 写进去和读出来的不一致。
  2. 读出来的脉冲计数值长度为 8 字节，实际的长度应当为 4 byte , 说明有异常。

- ? 不存在该问题 , 该读就读

  1.  读取命令 `01 03 00 14 00 08 CRC` 

     得到结果  `01 03 10 05 06 07 08 01 02 03 04 05 06 07 09 00 00 01 02 CRC`

     

- 0x10 地址的 '消息确认' 可以被读取，而文档它的权限为 '写入'



- 往 0x06 地址写入数据，写完之后读不了它，无论是读很长一段的数据或者是就读它这一节，都无法读到。

  ![image-20231205170454827](https://dearliao.oss-cn-shenzhen.aliyuncs.com/Note/picture/202404081000912.png)

  

- 寄存器的属性如果没有 "write"，但是依旧使用功能码 0x10 "写"，它不会返回错误码( 应当返回错误码的 )，

  ![image-20231205192843186](https://dearliao.oss-cn-shenzhen.aliyuncs.com/Note/picture/202404081000913.png)

  ![image-20231205192826795](https://dearliao.oss-cn-shenzhen.aliyuncs.com/Note/picture/202404081000914.png)

- 发送 DevEUI

  ![image-20231205193802017](https://dearliao.oss-cn-shenzhen.aliyuncs.com/Note/picture/202404081000915.png)









